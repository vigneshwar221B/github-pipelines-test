  deploy_prod_infra:
    strategy:
      max-parallel: 1
      matrix:
        include:
          - environment: 'prod-na'
            primary_region_tf_var_file: 'prod-na-primary'
            primary_region_name: 'prod-na-primary'
            # second_region_name
            secondary_region_tf_var_file: 'prod-na-secondary'
            second_region_name: 'prod-na-secondary'
          - environment: 'prod-eur'
            primary_region_tf_var_file: 'prod-eur-primary'
            primary_region_name: 'prod-eur-primary'
            # second_region_name
            secondary_region_tf_var_file: 'prod-eur-secondary'
            second_region_name: 'prod-eur-secondary'
          - environment: 'prod-apse'
            primary_region_tf_var_file: 'prod-apse-primary'
            primary_region_name: 'prod-apse-primary'
            # second_region_name
            secondary_region_tf_var_file: 'prod-apse-secondary'
            second_region_name: 'prod-apse-secondary'
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    environment: prod-base-infra
    needs:
      - func_test_api_qa
    if: ${{ github.ref == 'refs/heads/main' }}
    defaults:
      run:
        working-directory: base_infra
    steps:
      - uses: actions/checkout@v3
      - name: Download Lambda Packages
        uses: actions/download-artifact@v3
        with:
          name: lambda-package
          path: terraform
      - name: Use Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check
      - name: Set Up Terraform Workspace
        uses: sorenson-eng/shared-github-actions/create-tf-cloud-workspace@main
        with:
          apiToken: ${{ secrets.TF_API_TOKEN }}
          teamID: team-9oiEbg9n7LRqH8ch
          terraformWorkspaceName: ${{ github.event.repository.name }}-infra-${{ matrix.primary_region_name }}
          tfVarSet: varset-f2C3DJRZHGfvpwdR
          terraformDir: base_infra
      - name: Terraform Init
        id: init
        run: terraform init
      - name: Terraform Validate
        id: validate
        run: terraform validate
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
      - name: Terraform Plan
        id: plan
        run: terraform plan -var-file=${{ matrix.primary_region_tf_var_file }}.tfvars
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Terraform Apply
        id: apply
        run: terraform apply -var-file=${{ matrix.primary_region_tf_var_file }}.tfvars --auto-approve
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Set Up Terraform Workspace for second region
        uses: sorenson-eng/shared-github-actions/create-tf-cloud-workspace@main
        with:
          apiToken: ${{ secrets.TF_API_TOKEN }}
          teamID: team-9oiEbg9n7LRqH8ch
          terraformWorkspaceName: ${{ github.event.repository.name }}-infra-${{ matrix.second_region_name }}
          tfVarSet: varset-f2C3DJRZHGfvpwdR
          terraformDir: base_infra
      - name: Terraform Init on second region
        id: init_secondary_region
        run: terraform init
      - name: Terraform Plan on second region
        id: plan_secondary_region
        run: terraform plan -var-file=${{ matrix.secondary_region_tf_var_file }}.tfvars
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Terraform Apply on second region
        id: apply_secondary_region
        run: terraform apply -var-file=${{ matrix.secondary_region_tf_var_file }}.tfvars --auto-approve
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Send Chat Fail Notification
        if: failure()
        uses: sorenson-eng/shared-github-actions/send-teams-notification@main
        with:
          TeamsWebhookUrl: ${{ secrets.MSTEAMS_WEBHOOK }}
          jobName: '${{ github.job }}'
          jobUrl: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          jobRepo: ${{ github.repository }}
          triggeredBy: '${{ github.actor }}'

  deploy_prod:
    strategy:
      max-parallel: 1
      matrix:
        include:
          - environment: 'prod-na'
            tf_var_file: 'prod-na-primary'
            # second_region_name: This name/workspace is used to serves half of the traffic
            second_region_name: 'prod-na-uw2'
            secondary_tf_var_file: 'prod-na-secondary'
            # # multi_region_name: This name/workspace is used to created DNS and traffic policies for both the regions
            multi_region_name: 'prod-na-mr'
          - environment: 'prod-eur'
            tf_var_file: 'prod-eur-primary'
            second_region_name: 'prod-eur-secondary'
            multi_region_name: 'prod-eur-mr'
            secondary_tf_var_file: prod-eur-secondary
          - environment: 'prod-apse'
            tf_var_file: 'prod-apse-primary'
            second_region_name: 'prod-apse-secondary'
            multi_region_name: 'prod-apse-mr'
            secondary_tf_var_file: prod-apse-secondary
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    environment: prod
    needs:
      - deploy_prod_infra
    if: ${{ github.ref == 'refs/heads/main' }}
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v3
      - name: Download Lambda Packages
        uses: actions/download-artifact@v3
        with:
          name: lambda-package
          path: terraform
      - name: Download Synthetics Packages
        uses: actions/download-artifact@v3
        with:
          name: synthetics-package
          path: terraform
      - name: Use Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check
      - name: Set Up Terraform Workspace
        uses: sorenson-eng/shared-github-actions/create-tf-cloud-workspace@main
        with:
          apiToken: ${{ secrets.TF_API_TOKEN }}
          teamID: team-9oiEbg9n7LRqH8ch
          terraformWorkspaceName: ${{ github.event.repository.name }}-${{ matrix.environment }}
          tfVarSet: varset-f2C3DJRZHGfvpwdR
      - name: Terraform Init
        id: init
        run: terraform init
      - name: Terraform Validate
        id: validate
        run: terraform validate
      - name: Terraform Plan
        id: plan
        run: terraform plan -var-file=${{ matrix.tf_var_file }}.tfvars
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Terraform Apply
        id: apply
        run: terraform apply -var-file=${{ matrix.tf_var_file }}.tfvars --auto-approve
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
      - name: Collect Terraform Outputs
        id: tf_output
        run: |
          echo "aws_region=$(terraform output --raw aws_region)" >> $GITHUB_OUTPUT
          echo "aws_account_id=$(terraform output --raw aws_account_id)" >> $GITHUB_OUTPUT
          echo "api_url=$(terraform output api_gateway_canonical_url)" >> $GITHUB_OUTPUT
          echo "primary_region_url=$(terraform output --raw custom_domain_url)" >> $GITHUB_OUTPUT
          echo "us_east_1_synthetic_health_check_id=$(terraform output --raw synthetic_health_check_id)" >> $GITHUB_OUTPUT
          echo "primary_websocket_url=$(terraform output --raw websocket_url)" >> $GITHUB_OUTPUT
          echo "websocket_domain_name=$(terraform output --raw websocket_domain_name)" >> $GITHUB_OUTPUT
      - name: Set Up Terraform Workspace for second region
        uses: sorenson-eng/shared-github-actions/create-tf-cloud-workspace@main
        with:
          apiToken: ${{ secrets.TF_API_TOKEN }}
          teamID: team-9oiEbg9n7LRqH8ch
          terraformWorkspaceName: ${{ github.event.repository.name }}-${{ matrix.second_region_name }}
          tfVarSet: varset-f2C3DJRZHGfvpwdR
      - name: Terraform Init on second region
        id: init_secondary_region
        run: terraform init
      - name: Terraform Plan on second region
        id: plan_secondary_region
        run: terraform plan -var-file=${{ matrix.secondary_tf_var_file }}.tfvars
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
          TF_VAR_isSecondaryRegion: true
      - name: Terraform Apply on second region
        id: apply_secondary_region
        run: terraform apply -var-file=${{ matrix.secondary_tf_var_file }}.tfvars --auto-approve
        env:
          TF_VAR_aws_account_id: '${{ vars.PROD_AWS_ACCOUNT_ID}}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
          TF_VAR_isSecondaryRegion: true
      - name: Collect Terraform Outputs for second region
        id: tf_output_secondary_region
        run: |
          echo "secondary_region_url=$(terraform output --raw custom_domain_url)" >> $GITHUB_OUTPUT
          echo "hosted_zone_id=$(terraform output --raw hosted_zone_id)" >> $GITHUB_OUTPUT
          echo "domain_name=$(terraform output --raw domain_name)" >> $GITHUB_OUTPUT
          echo "environment=$(terraform output --raw environment)" >> $GITHUB_OUTPUT
          echo "us_west_2_synthetic_health_check_id=$(terraform output --raw synthetic_health_check_id)" >> $GITHUB_OUTPUT
          echo "aws_region=$(terraform output --raw aws_region)" >> $GITHUB_OUTPUT
          echo "secondary_websocket_url=$(terraform output --raw websocket_url)" >> $GITHUB_OUTPUT
      - name: Set Up Terraform Workspace for Multi Region
        uses: sorenson-eng/shared-github-actions/create-tf-cloud-workspace@main
        with:
          apiToken: ${{ secrets.TF_API_TOKEN }}
          teamID: team-9oiEbg9n7LRqH8ch
          terraformWorkspaceName: ${{ github.event.repository.name }}-deploy-${{ matrix.multi_region_name }}
          tfVarSet: varset-f2C3DJRZHGfvpwdR
          terraformDir: terraform/multi-region
      - name: Terraform Init for Multi region
        id: init_mr
        run: terraform init
        working-directory: terraform/multi-region
      - name: Terraform Plan for Multi region
        id: plan_mr
        run: terraform plan
        working-directory: terraform/multi-region
        env:
          TF_VAR_aws_account_id: '${{ steps.tf_output.outputs.aws_account_id}}'
          TF_VAR_provider_region: '${{ steps.tf_output.outputs.aws_region}}'
          TF_VAR_primary_region_url: '${{ steps.tf_output.outputs.primary_region_url }}'
          TF_VAR_secondary_region_url: '${{ steps.tf_output_secondary_region.outputs.secondary_region_url }}'
          TF_VAR_hosted_zone_id: '${{ steps.tf_output_secondary_region.outputs.hosted_zone_id }}'
          TF_VAR_domain_name: '${{ steps.tf_output_secondary_region.outputs.domain_name}}'
          TF_VAR_environment: '${{ steps.tf_output_secondary_region.outputs.environment }}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_region_1_health_check_id: ${{ steps.tf_output.outputs.us_east_1_synthetic_health_check_id }}
          TF_VAR_region_2_health_check_id: ${{ steps.tf_output_secondary_region.outputs.us_west_2_synthetic_health_check_id }}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
          TF_VAR_primary_region: ${{ steps.tf_output.outputs.aws_region }}
          TF_VAR_secondary_region: ${{ steps.tf_output_secondary_region.outputs.aws_region }}
          TF_VAR_primary_websocket_url: ${{ steps.tf_output.outputs.primary_websocket_url }}
          TF_VAR_secondary_websocket_url: ${{ steps.tf_output_secondary_region.outputs.secondary_websocket_url }}
          TF_VAR_websocket_domain_name: ${{ steps.tf_output.outputs.websocket_domain_name }}
      - name: Terraform Apply for Multi region
        id: apply_mr
        run: terraform apply --auto-approve
        working-directory: terraform/multi-region
        env:
          TF_VAR_aws_account_id: '${{ steps.tf_output.outputs.aws_account_id}}'
          TF_VAR_provider_region: '${{ steps.tf_output.outputs.aws_region}}'
          TF_VAR_primary_region_url: '${{ steps.tf_output.outputs.primary_region_url }}'
          TF_VAR_secondary_region_url: '${{ steps.tf_output_secondary_region.outputs.secondary_region_url }}'
          TF_VAR_hosted_zone_id: '${{ steps.tf_output_secondary_region.outputs.hosted_zone_id }}'
          TF_VAR_domain_name: '${{ steps.tf_output_secondary_region.outputs.domain_name}}'
          TF_VAR_environment: '${{ steps.tf_output_secondary_region.outputs.environment }}'
          TF_VAR_cognito_username: ${{ secrets.COGNITO_SERVICE_ACCOUNT_USERNAME}}
          TF_VAR_cognito_password: ${{ secrets.COGNITO_SERVICE_ACCOUNT_PASSWORD}}
          TF_VAR_region_1_health_check_id: ${{ steps.tf_output.outputs.us_east_1_synthetic_health_check_id }}
          TF_VAR_region_2_health_check_id: ${{ steps.tf_output_secondary_region.outputs.us_west_2_synthetic_health_check_id }}
          TF_VAR_teams_url: ${{ secrets.PROD_MESSENGER_URL}}
          TF_VAR_primary_region: ${{ steps.tf_output.outputs.aws_region }}
          TF_VAR_secondary_region: ${{ steps.tf_output_secondary_region.outputs.aws_region }}
          TF_VAR_primary_websocket_url: ${{ steps.tf_output.outputs.primary_websocket_url }}
          TF_VAR_secondary_websocket_url: ${{ steps.tf_output_secondary_region.outputs.secondary_websocket_url }}
          TF_VAR_websocket_domain_name: ${{ steps.tf_output.outputs.websocket_domain_name }}
      - name: Send Chat Fail Notification
        if: failure()
        uses: sorenson-eng/shared-github-actions/send-teams-notification@main
        with:
          TeamsWebhookUrl: ${{ secrets.MSTEAMS_WEBHOOK }}
          jobName: '${{ github.job }}'
          jobUrl: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          jobRepo: ${{ github.repository }}
          triggeredBy: '${{ github.actor }}'
